@model List<trnservice.Models.TrnSearchRequestViewModel>
@{
    ViewData["Title"] = "TRN Validation Service";
}

<h5 class="card-title fw-semibold mb-4">Bulk TRN Validation</h5>
<form id="uploadForm" method="post" enctype="multipart/form-data" asp-action="Upload" class="mb-3">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <label class="form-label">Upload CSV File</label>
    <div class="mb-3">
        <input type="file" name="file" accept=".csv" style="margin-bottom: 10px;" />
    </div>
    <div class="form-group mb-3">
        <input id="uploadBtn" type="submit" value="Upload" class="btn btn-primary" />
    </div>
</form>

<!-- Loading Bar -->
<div id="loadingBar" class="progress" style="display: none;">
    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
    
</div>

<script src="~/libs/jquery/dist/jquery.min.js"></script>
<script src="~/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/sidebarmenu.js"></script>
<script src="~/js/app.min.js"></script>
<script src="~/libs/simplebar/dist/simplebar.js"></script>

<script>
    $(document).ready(function () {

        // Function to show/hide the loading bar
        function toggleLoadingBar(show) {
            if (show) {
                $("#loadingBar").show();
                $("#uploadBtn").hide();
            } else {
                $("#loadingBar").hide();
                $("#uploadBtn").show();
            }
        }

        $("#uploadForm").submit(function (event) {
            // Prevent the default form submission
            event.preventDefault();

            // Show loading bar
            toggleLoadingBar(true);

            // Submit the form using AJAX
            $.ajax({
                url: $(this).attr("action"),
                type: $(this).attr("method"),
                data: new FormData(this),
                processData: false,
                contentType: false,
                success: function (response) {
                    // Hide loading bar after the action is completed
                    toggleLoadingBar(false);

                    // If response file is null and response defaults to html page
                    if (response.startsWith('<!DOCTYPE html>')) {
                        return;
                    }
                    // Handle the response (assuming it's the file for download)
                    // Create a Blob from the response
                    var blob = new Blob([response], { type: 'application/octet-stream' });

                    // Create a download link
                    var link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = `BULK_TRN_Results.csv`;

                    // Append the link to the body
                    document.body.appendChild(link);

                    // Trigger a click event on the link to initiate the download
                    link.click();

                    // Remove the link from the body
                    document.body.removeChild(link);
                },
                error: function (error) {
                    // Handle error (if needed)
                },
                complete: function () {
                    // Hide loading bar after the action is completed
                    toggleLoadingBar(false);
                }
            });
        });
    });
</script>